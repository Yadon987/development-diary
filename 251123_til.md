# TIL - 2025年11月23日

## 今日のメモ
勉強時間：7時間

髪を切りに行ったり、名札ホルダーを買いに行ったり、もくもく会の準備などあまりアプリ開発はできなかったが充実した1日だった

# 🚀 Google認証機能の実装 (Devise + OmniAuth)
## 📝 概要
ヘルスケアアプリ『てくてくメモリア』において、ユーザーの利便性向上とGoogle Fit連携の基盤を作るため、Googleアカウントを用いたOAuth認証機能を実装しました。 既存のメールアドレス認証（Devise）と共存させ、シームレスなログイン体験を提供しています。
## 💡 こだわり・工夫したポイント
### 1\. セキュアな認証情報管理 🔒
APIキーなどの機密情報は、コードに直接記述せず、Rails標準の暗号化機能 **Rails Credentials** (
![](//:0)
config/credentials.yml.enc) を使用して管理しています。 また、開発環境やCI環境でキーが存在しない場合でもアプリケーションがクラッシュしないよう、設定読み込み部分にフェイルセーフな記述を実装し、開発者体験（DX）を損なわないよう配慮しました。

```

\# config/initializers/devise.rb
\# Credentialsがない環境でもエラーにならないよう空ハッシュをデフォルトに設定
google\_creds = Rails.application.credentials.google || {}
config.omniauth :google\_oauth2, google\_creds\[:client\_id\], ...
```
### 2\. 将来の拡張性を見据えたスコープ設計 🏃
単なるログインだけでなく、将来的な「歩数・活動量データの取得」を見据え、Google Fit APIに関連するスコープ（`fitness.activity.read` 等）を初期段階から適切に設定しました。これにより、機能追加時の再認可の手間を削減しています。
### 3\. Turbo Driveに対応したUI実装 ⚡️
Rails 7の標準であるTurbo Drive環境下でも正しく動作するよう、リンク（GET）ではなく `button_to` ヘルパーを用いたPOSTリクエストとして認証ボタンを実装しました。 また、ログイン画面だけでなく**新規登録画面**にも認証ボタンを配置し、初見ユーザーの離脱率低下を意識した導線設計を行いました。
## 🐛 直面した課題と解決プロセス
実装中にいくつかの環境依存エラーに直面しましたが、ログを分析し根本原因を特定して解決しました。
- **課題:** テスト実行時に `SQLite3::ReadOnlyException` が発生。
    - **原因:** テスト用データベースファイルの所有権限がrootになっており、書き込みがブロックされていた。
    - **解決:** ファイルの権限を修正し、`db:test:prepare` でテスト環境を再構築することで解決。
- **課題:** `master.key` 紛失による起動エラー。
    - **解決:** 既存の暗号化ファイルをリセットし、キーを再生成して環境を復旧。チーム開発を想定し、キー管理の重要性を再認識しました。
## ✅ 品質担保 (Testing)
**RSpec** を導入し、認証ロジックの単体テストを実装しました。 特に `User.from_omniauth` メソッドにおいて、以下のケースを自動テストで保証しています。
-  **既存ユーザー:** 既存のアカウントを特定し、Googleのトークン情報を更新してログインできること。
-  **新規ユーザー:** 新しいユーザーレコードを作成し、適切に保存されること。

## 気分・状態
今日の気分: 🙂 (3: 普通)
今日のモチベーション: 🌞 (4: やる気がある)
目標の進捗: 🌿 (4: よく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-11-23*  
*Created: 2025-11-23 21:52:03*
