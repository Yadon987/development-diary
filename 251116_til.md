# TIL - 2025年11月16日

## 今日のメモ
勉強時間：8時間

# [FIX] アセットパイプラインの全面的なデバッグと安定構成への復旧

## 概要

本作業は、Render環境へのデプロイ時に発生した `sassc` LoadError を起点とする、アセットパイプライン（CSS/JS）の根本的な問題解決を記録するものです。

開発環境（Docker）と本番環境（Render）間でのビルド構成の差異を解消するため、`importmap`/CDN構成から`jsbundling`/`cssbundling`（ビルドベース）構成への移行を試みました。

このプロセスにおいて、最終的にローカル開発環境がクラッシュする（`ERR_EMPTY_RESPONSE`）深刻な状態に陥りましたが、体系的なデバッグと原因の切り分けを経て、最終的に安定構成（`importmap`/CDN）に復旧させました。

---

## 🚀 実施した主なデバッグと解決策

### 1. Git履歴のクリーンアップ

* **問題:** `vendor/bundle` が誤ってGitの追跡対象となり、GitHubの100MBファイルサイズ制限エラーで `push` が拒否されました。
* **解決:** `.gitignore` を修正し、`git reset --soft` と `git rm --cached` を使用してGit履歴から巨大ファイルを除外。その後、`git push --force-with-lease` を使用してリモートの `main` ブランチの履歴を安全に修正しました。

### 2. アセットパイプラインの移行と競合解決

`jsbundling`/`cssbundling` への移行を試みた際に、以下の複数のエラーに直面し、これらを（一時的に）解決しました。

* **`Sprockets::DoubleLinkError`:** `manifest.js` がビルド後のJS（`builds`）とビルド前のJS（`javascript`）を二重に読み込んでいたため、`javascript` への `link_tree` を削除して解決。
* **`LoadError: sassc`:** `cssbundling` 環境下で `sprockets-rails` が不要なCSSを読み込もうとしていたため、`manifest.js` の `stylesheets` への `link_directory` を削除して解決。
* **`NameError: javascript_importmap_tags`:** `jsbundling` 構成では不要な `importmap-rails` Gemを `Gemfile` から削除し、`application.html.erb` のヘルパーを `javascript_include_tag` に置換して解決。

### 3. Docker環境のビルドプロセスデバッグ

アセット構成の変更後、ローカル環境が `ERR_EMPTY_RESPONSE` でクラッシュ。`css.1` (Tailwindビルド) プロセスがサイレントに失敗していることが根本原因でした。

* **原因特定:** `css.1` プロセスが `npm error could not determine executable to run` で即時クラッシュしていることを特定。
* **原因分析:** `package.json` が `npx tailwindcss` を呼び出しているにも関わらず、NPMパッケージの `tailwindcss` 本体が未インストールであったことが原因でした。
* **関連問題の修正:**
    * `tailwind.config.js` を新規作成し、CDNから設定を移行。
    * `package.json` の `--watch` オプション重複による構文エラーを修正。
    * `Procfile.dev` の `rails s` に `-b 0.0.0.0` を追加し、Dockerの `ERR_CONNECTION_REFUSED` を解決。

---

## 📚 最終的な結論と復旧

`tailwindcss` パッケージのインストール後も `css.1` が `executable not found` でクラッシュし続ける状況（`node_modules` と `yarn.lock` の不整合）に直面しました。

この複雑な環境問題を解決し、安定した開発を優先するため、**`git reset --hard` を実行**。

すべての変更を破棄し、当初の**安定構成であった `importmap`/CDN（ビルド不要）の構成にロールバック**しました。

最終的に、`Procfile.dev` からビルド移行時に追加した不要な `js:` と `css:` のプロセス定義を削除し、`web: rails s -b 0.0.0.0` のみを実行するように修正。これにより、`ERR_EMPTY_RESPONSE` エラーが完全に解消され、**ローカル開発環境が正常に復旧しました。**

## 気分・状態
今日の気分: 😐 (2: 少し落ち込み気味)
今日のモチベーション: 🌞 (4: やる気がある)
目標の進捗: 🌰 (2: あまり進まなかった)

---
*Generated by ちいくさ日記*  
*Date: 2025-11-16*  
*Created: 2025-11-17 00:06:58*
