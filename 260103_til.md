# TIL - 2026年01月03日

## 今日のメモ
勉強時間：10時間

ゲスト権限とバックアップ・テスト安定化を並行して進めることができ、非常に密度の高い一日でした。

# 🛠️ 開発日誌 (2026/01/03) - ゲスト機能強化とシステム堅牢化の完遂 🚀

本日は、ゲストユーザー向けのアクセス制御といった**機能面の拡充**に加え、N+1問題の解消やバックアップ基盤の改善など、**システムの信頼性と保守性を高める非機能要件の強化**に注力しました。

---

## 🎯 本日の主な成果

### 1. ユーザー体験とセキュリティの向上 🔐
* **ゲスト管理者向けのアクセス制御**:
    - `Admin::BaseController` の認可ロジックをリファクタリング。ダッシュボード閲覧などの管理体験は提供しつつ、機密性の高い操作は制限するセキュアな実装を完了しました。
* **フロントエンドのセキュリティ対策**:
    - `target="_blank"` を使用するすべての外部リンクに対し、Tabnabbing対策（`rel="noopener noreferrer"`）を実施。併せて環境変数（`ENV`）管理を徹底し、機密情報のハードコードを排除しました。

### 2. パフォーマンス最適化とロジックの堅牢化 ⚡
* **N+1問題の抜本的解消**:
    - `ReactionSummaryService` や各種リマインダーサービスにおいて、Eager Loadingの最適化および事前にSQLで対象を絞り込む実装へ変更。ループ内クエリを排除し、DB負荷を最小化しました。
* **外部API連携のレジリエンス強化**:
    - `WeatherService` やGoogle Fit連携にて、外部レスポンスが不正な場合のフォールバック処理を追加。外部要因によるシステム停止を防ぐ「防御的プログラミング」を徹底しました。

### 3. 開発基盤の安定化と品質保証（DevOps & Test） 🛠️
* **Dockerを活用した互換性の解消**:
    - WSL2(ローカル)とサーバー間の `pg_dump` バージョン不一致問題を、Dockerコンテナ経由で実行する手法に切り替えることで解決。環境差異に依存しない安定したバックアップ環境を構築しました。
* **System Specの安定化と全テストGreen**:
    - 非同期処理（JSアニメーション等）に起因するFlakyなテスト失敗を、Capybaraの待機処理の適正化によって修正。**全321件のテストケースをパス**させ、リグレッションがないことを確認しました。

---

## 💻 技術的な解決策の抜粋

### ■ N+1問題の解消 (ReminderService)
ループ内で毎回クエリを発行する非効率な実装を、サブクエリを用いた一括抽出に改善しました。

```ruby
# 事前にSQLで絞り込み、メモリとDB負荷を最適化
User.where(walk_reminder_enabled: true)
    .where.not(id: Walk.where(walked_on: Date.current).select(:user_id))
    .find_each do |user|
      # 通知処理の実行
    end
```

### ■ Docker経由の pg_dump 実行 (bin/Backup_full.sh)
ローカルのバイナリバージョンに依存しない、ポータブルなバックアップスクリプトへ修正しました。

```bash
# 修正後のスクリプト抜粋
docker run --rm postgres:17-alpine pg_dump "$DATABASE_URL" --no-owner --no-acl > "$TEMP_DIR/database_dump.sql"
```

---

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-01-03*  
*Created: 2026-01-03 22:00:00*
