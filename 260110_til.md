# TIL - 2026年01月10日

## 今日のメモ
勉強時間：11時間

図解即戦力 UMLのしくみと実装がこれ1冊でしっかりわかる教科書を読み進め中　これだけわかりやすく書いてる図解だらけの本でも難しい

# 📅 開発日誌 (2026/01/10)

## 📝 タスク: 管理画面における記事検索機能の拡張

### 📌 概要

管理画面の記事一覧ページにおいて、従来の「カテゴリ」「タイトル」による検索に加え、**「著者」「タグ」「記事本文」**による絞り込み検索機能を実装しました。
既存のアーキテクチャ（Form Object パターン）を活かしつつ、保守性とパフォーマンスを意識した実装を行いました。


### 🛠 技術的アプローチと工夫点

#### 1. 既存設計（Form Object）の尊重と拡張

当初は検索用 Gem `Ransack` の導入を検討しましたが、既存のテストコード（RSpec）がフォームオブジェクト経由のリクエストパラメータ（`q[body]`など）を前提に書かれていることを確認しました。
テストコードを修正して Gem に合わせるのではなく、**「既存のテスト仕様を正」とし、現在の設計パターン（SearchArticlesForm）を拡張する方針**を採用しました。これにより、既存機能への影響を最小限に抑えつつ要件を満たすことができました。

```ruby
# app/forms/search_articles_form.rb (拡張例)
def search
  relation = Article.distinct
  # 既存のカテゴリスコープに加え、著者・タグ・本文のスコープを条件付きで適用
  relation = relation.by_author(author_id) if author_id.present?
  relation = relation.by_tag(tag_id) if tag_id.present?
  relation = relation.body_contain(body) if body.present?
  # ...
end
```

#### 2. モデルへのスコープ切り出しと複雑な結合

コントローラーやフォームにロジックを漏れさせないため、検索条件はモデルの `scope` として定義しました。
特に「記事本文」の検索は、`Article` モデル自体ではなく、関連する `Sentence` モデル（ `ArticleBlock` 経由）にあるため、`joins` を用いて結合検索を行いました。

```ruby
# 記事内容への検索スコープ (関連テーブルをJOINして検索)
scope :body_contain, ->(body) { joins(:sentences).where('sentences.body LIKE ?', "%#{body}%") }
```

#### 3. パフォーマンス対策 (N+1 問題の解消)

検索条件が増えることで表示項目も増えるため、一覧表示時の SQL 発行数に注意しました。
`includes` メソッドを使用して関連する `category`, `author`, `tags` を Eager Loading し、N+1 問題を未然に防ぎました。

```ruby
@articles = @search_articles_form.search.includes(:category, :author, :tags)...
```

### 🐛 トラブルシューティング

Docker 開発環境において、テスト実行時に DB 接続エラーが発生しました。
調査の結果、ポート競合（別プロジェクトのコンテナ起動）やネットワークの不整合が原因であることが判明。
`docker-compose down` による完全停止とネットワーク再構築を行い、DB 起動を待機してからテストを実行す

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌞 (4: やる気がある)
目標の進捗: 🌿 (4: よく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-01-10*  
*Created: 2026-01-10 22:15:52*
