# TIL - 2025年12月04日

## 今日のメモ
勉強時間：12時間

2日連続寝落ち…でも5日にはMVPリリースできそう！

# 📅 開発日誌 - 2025年12月5日
## 🎯 本日の開発テーマ
**「ユーザーエンゲージメントを高めるゲーミフィケーション実装と、本番環境の堅牢化」**
本日は、アプリの顔となるホーム画面の機能強化（ランキング・最新投稿）と、本番環境で発生していたクリティカルな認証エラーの解消を行いました。
---
## 🚀 実装・改善した機能
### 1. ゲーミフィケーション：ランキング機能のホーム画面統合
ユーザーの継続率（Retention）向上を目的として、ホーム画面に「月間ランキング」を表示するカードを実装しました。
**工夫した点：モチベーション設計**
- **分母の選定:** 当初は「今月歩いたユーザー数」を分母にする予定でしたが、**「全ユーザー数」**に変更しました。これにより、歩いていないユーザーも分母に含まれるため、アクティブユーザーが上位に入りやすくなり、「自分は上位にいる」という自己肯定感を高める設計にしました。
- **視覚的フィードバック:** SVGの `stroke-dasharray` を活用した円形プログレスバーを実装。順位に応じて動的にメーターが変化し、1位の場合は完全に満タンになるよう計算式を調整しました。
**技術スタック:**
- ActiveRecord (`group`, `having`, `joins`)
- SVG / Tailwind CSS
- Ruby (`sprintf` によるフォーマット制御)
### 2. UX改善：投稿一覧の表示順序バグ修正 🐛
「投稿が新しい順に表示されない」という不具合を調査・修正しました。
**原因分析と解決:**
- **仮説検証:** キャッシュ、DBの保存順、クエリの不備を順に検証。
- **根本原因:** ダミーデータ生成スクリプト ([seeds.rb](cci:7://file:///home/nukon999/workspace/tekumemo/db/seeds.rb:0:0-0:0)) が、現在時刻より**未来の時刻**でデータを生成していたことを特定。
- **恒久対策:**
  1. [seeds.rb](cci:7://file:///home/nukon999/workspace/tekumemo/db/seeds.rb:0:0-0:0) のロジックを修正し、必ず過去の時刻で生成するように変更。
  2. `Post.recent` スコープでテーブル名を明示し、[id](cci:1://file:///home/nukon999/workspace/tekumemo/app/models/user.rb:45:2-48:5) 降順をセカンダリキーに追加してソート順を保証。
  3. `includes` を `preload` に変更し、JOINによるソートへの副作用を排除。
### 3. インフラ・セキュリティ：本番環境でのCSRFエラー対応 🛡️
本番環境（Cloudflare経由）でのみログイン時に `ActionController::InvalidAuthenticityToken` が発生する問題を解決しました。
**技術的なアプローチ:**
- **ログ解析:** ログからCSRFトークン検証失敗を確認。
- **原因:** `SameSite` 属性の設定と、プロキシ経由時のOriginヘッダー検証の厳格さが原因と推測。
- **対策:**
  - [config/initializers/session_store.rb](cci:7://file:///home/nukon999/workspace/tekumemo/config/initializers/session_store.rb:0:0-0:0): `same_site: :none` から `:lax` に変更し、標準的なセキュリティポリシーに準拠。
  - [config/environments/production.rb](cci:7://file:///home/nukon999/workspace/tekumemo/config/environments/production.rb:0:0-0:0): `forgery_protection_origin_check = false` を設定し、プロキシ環境下での過剰なOriginチェックを緩和。
---
## 🛠️ 技術的な挑戦と学び
### テスト環境の最適化
システムテスト（E2E）がDockerコンテナのメモリ不足（OOM Killer）を引き起こす問題に直面しました。
これに対し、**「CI/CDパイプラインとローカル開発の分離」**を意識し、ローカルではシステムテストを標準で除外（[.rspec](cci:7://file:///home/nukon999/workspace/tekumemo/.rspec:0:0-0:0)設定）し、必要な場合のみ個別実行する運用フローを確立しました。これにより、開発速度を落とさずに品質を担保できるようになりました。
### ActiveRecordの挙動理解
`includes`（Eager Loading）が内部的に `LEFT OUTER JOIN` を発行する場合があり、それが `ORDER BY` 句に影響を与える挙動を再確認しました。意図しない挙動を防ぐため、`preload` を使い分ける重要性を学びました。
---
## 💭 エンジニアとしての所感
本日は「仕様の実装」だけでなく、「なぜその仕様にするのか（ユーザー心理）」と「なぜ動かないのか（深層原因の特定）」に深く向き合えた1日でした。
特にランキング機能における分母の決定プロセスは、単なるコーディング以上の「サービス設計」の視点を持てたと感じています。また、本番環境特有のCSRFエラーの解決を通じて、Webアプリケーションのセキュリティとインフラ（プロキシ、Cookie）への理解が深まりました。
---
## スクリーンショット
| 機能 | スクリーンショット |
| --- | --- |
| ランキング画面 | <img width="687" height="1226" alt="image" src="https://github.com/user-attachments/assets/700e656b-7d62-4224-a39c-a7e778dcc0de" /> |

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-12-04*  
*Created: 2025-12-05 05:32:08*
