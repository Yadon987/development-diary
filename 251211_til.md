# TIL - 2025年12月11日

## 今日のメモ
勉強時間：9時間

冷蔵庫の賞味期限の切れたマヨネーズのせいで体調は絶不調。あまり集中はできなかった。

# 開発日誌 - 2025年12月11日
## 📝 実装内容サマリー
「てくメモ」に**通知機能**を実装し、運営からのお知らせを全ユーザーに配信できる仕組みを構築しました。
また、既存のStatsServiceにおける単位変換バグを発見・修正し、テストの品質を向上させました。
---
## ✨ 主な実装機能
### 🔔 通知システムの構築
- **Announcementモデル**: 運営からのお知らせを管理
  - 公開/非公開の制御、緊急度の設定（info/warning/urgent）
  - Active Recordコールバックによる自動通知作成
- **Notificationモデル**: ユーザーごとの通知を管理
  - 未読/既読ステータスの管理
  - scopeを活用した効率的なクエリ設計
- **NotificationsController**: 通知一覧表示、既読処理、一括既読機能を実装
### 🎨 UI/UXの改善
- ホーム画面のお知らせカードをリニューアル
  - 表示件数を20件→3件に制限し、視認性を向上
  - カード全体をリンク化し、ホバー時のフローティングエフェクトを追加
  - 未読バッジをヘッダーとFABボタンに実装
- 通知一覧画面のデザインを統一
  - PCでの横幅を`max-w-2xl`に制限し、ホーム画面と統一感を確保
### 🛠 データ管理機能
- 初期データ投入用のRakeタスク（`announcement:import`）を作成
  - 本番環境での運用を考慮し、重複防止ロジックを実装
---
## 🐛 バグ修正とテスト改善
### StatsServiceの単位変換バグ修正
**問題**: [distance](cci:1://file:///home/nukon999/workspace/tekumemo/app/services/stats_service.rb:34:2-37:5)カラムがメートル単位で保存されているにも関わらず、一部のメソッドでキロメートルとして扱っていた
**修正内容**:
- [average_pace](cci:1://file:///home/nukon999/workspace/tekumemo/app/services/stats_service.rb:184:2-195:5): メートル→キロメートルの変換処理を追加（8000m → 8km）
- [pace_trend_last_30_days](cci:1://file:///home/nukon999/workspace/tekumemo/app/services/stats_service.rb:197:2-226:5): 同様の単位変換を実装
- [monthly_goal_achievement_rate](cci:1://file:///home/nukon999/workspace/tekumemo/app/services/stats_service.rb:39:2-45:5): 不要な単位変換ロジックを削除
**テスト設計の改善**:
- 「今月の距離」テストを独立したdescribeブロックに分離
- 先月のデータを使用することで、テストの意図を明確化
- 結果: 失敗していた2件のテストが修正により全てパス
---
## 🔧 CI/CD環境の整備
### GitHub Actions CIの修正
**課題**: アセットプリコンパイルエラーによるCI失敗
**解決プロセス**:
1. **Minitestの削除**: RSpec採用に伴い不要な`test/`ディレクトリを削除
2. **CSSビルドプロセスの追加**: `yarn build:css`をCI実行フローに組み込み
3. **テスト環境の設定**: `config.assets.compile = true`を追加し、動的コンパイルを有効化
4. **コミット履歴の整理**: 複数の修正コミットを`git rebase`で統合し、クリーンな履歴を維持
**結果**: 全131テストがCI上でパス ✅
---
## 📊 技術スタック
- **Backend**: Ruby on Rails 7.2, PostgreSQL
- **Frontend**: ERB, TailwindCSS, Stimulus
- **Testing**: RSpec, FactoryBot, Capybara
- **CI/CD**: GitHub Actions, Render
- **Database**: Supabase (PostgreSQL)
---
## 🎯 学んだこと・工夫した点
### 1. データの整合性を保つ設計
- `after_commit`コールバックを使用し、トランザクション完了後に通知を作成
- これにより、お知らせの保存失敗時に通知だけが残る不整合を防止
### 2. パフォーマンスへの配慮
- N+1クエリを防ぐため、scopeとeager loadingを活用
- 通知の取得範囲を`recent(3.months)`に制限
### 3. テスト駆動開発の実践
- 機能実装前にRSpecテストを作成
- エッジケースを想定したテストケースを追加（例: 記録が0件の場合）
### 4. 本番環境を意識した運用設計
- Renderの無料プランではシェルが使えないため、Supabaseの管理画面からSQLで直接データ投入
- 管理者権限の付与も同様にSQLで対応
---
## 🚀 今後の展開
- [ ] リマインダー機能の実装（不活発ユーザーへの通知）
- [ ] PWA対応によるプッシュ通知の実装
- [ ] お知らせのカテゴリ分類機能
---
## 📸 スクリーンショット
<img width="954" height="556" alt="image" src="https://github.com/user-attachments/assets/fd8b23bc-e483-47bd-a065-2cdb5218487a" />

## 気分・状態
今日の気分: 😞 (1: 落ち込んでいる)
今日のモチベーション: ☔ (1: やる気が全くない)
目標の進捗: 🌿 (4: よく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-12-11*  
*Created: 2025-12-11 23:58:51*
