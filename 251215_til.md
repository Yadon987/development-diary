# TIL - 2025年12月15日

## 今日のメモ
勉強時間：11時間

技術記事を作成中、久しぶりに昼寝ができて午後からの勉強がすこぶるはかどった

# 📝 開発日誌 - 2025 年 12 月 15 日
## 👨‍💻 プロジェクト概要
**プロジェクト名**: Tekumemo（散歩記録 SNS）
**使用技術**: Rails 7.2.3 / Ruby 3.2 / PostgreSQL / Hotwire (Turbo + Stimulus)
**開発環境**: Docker / GitHub Actions CI/CD
---
## 🎯 本日の目標
管理者パネルの機能拡充と、運用を想定した異常検知システムの実装
---
## ✨ 実装内容
### 1. 管理者ダッシュボードの実装 ⭐
**実装時間**: 約 40 分
#### 機能概要
- ユーザー・投稿・散歩記録の統計情報の可視化
- 人気投稿 TOP5 の表示
- 最近のアクティビティ表示
- リアルタイム異常検知システム
#### 技術的なポイント
- ActiveRecord の集計クエリを活用（`count`, `sum`, `left_joins`）
- N+1 問題の回避（`includes(:user)` による事前読み込み）
- SQL インジェクション対策（プレースホルダーの使用）
主な実装コード（Admin::DashboardController）:
    # 統計情報の取得
    @total_users = User.count
    @active_users_this_month = User.where(
      "current_sign_in_at >= ?",
      Time.current.beginning_of_month
    ).count
    # N+1対策を施した人気投稿の取得
    @popular_posts = Post.left_joins(:reactions)
      .select('posts.*, COUNT(reactions.id) as reactions_count')
      .group('posts.id')
      .order('reactions_count DESC')
      .limit(5)
      .includes(:user)
---
### 2. 検索・フィルタリング機能の実装 ⭐
**実装時間**: 約 30 分
#### 対象画面
- ユーザー管理（名前・メールアドレス検索 / 権限フィルタ）
- 投稿管理（本文・ユーザー名検索 / 天気・気分フィルタ）
- 散歩記録管理（ユーザー名検索 / 距離範囲・日付範囲フィルタ）
- お知らせ管理（タイトル・本文検索 / 種類・公開状態フィルタ）
#### 技術的な工夫
- PostgreSQL の `ILIKE` による大文字小小文字を区別しない部分一致検索
- パラメータのサニタイジング（`%#{params[:q]}%` のプレースホルダー化）
- UX を考慮したクリアボタンの実装
検索実装例:
    if params[:q].present?
      search_term = "%#{params[:q]}%"
      @users = @users.where(
        "name ILIKE ? OR email ILIKE ?",
        search_term,
        search_term
      )
    end
---
### 3. 散歩記録管理機能の追加 ⭐
**実装時間**: 約 25 分
#### 背景
ランキング機能があるにも関わらず、散歩記録の管理機能が欠けていることに気づき、追加実装を決定。
#### 実装内容
- 散歩記録の一覧・詳細・削除
- 複数条件での検索（ユーザー名、距離範囲、日付範囲）
- 異常値（50km 以上、10 万歩以上）の赤色強調表示
#### 設計判断
- CRUD のうち、作成・編集は不要と判断（管理者が散歩記録を作成する必要はない）
- 読み取り専用の管理画面として、削除機能のみ提供
---
### 4. 異常検知システムの実装 🚨⭐⭐
**実装時間**: 約 50 分
#### 実装背景
サービスの健全性を保つため、能動的に問題を発見できるシステムが必要と判断。
#### 検知項目
1. **スパム疑いユーザー**
   - 24 時間以内に 20 件以上投稿
   - 登録から 1 時間以内に 5 件以上投稿（BOT 検出）
2. **データ整合性エラー**
   - 散歩距離が 50km 以上（GPS 異常の可能性）
   - 歩数が 10 万歩以上（センサー異常の可能性）
3. **セキュリティ懸念**
   - 最終ログインが 30 日以上前なのに、最近 7 日以内に投稿（アカウント乗っ取りの可能性）
4. **非アクティブアカウント**
   - 投稿・散歩記録が 0 件で登録から 30 日以上経過（放置アカウント）
#### UI/UX 設計
- 異常なし: 緑色のグロー効果で「✓ システム正常」
- 異常あり: 赤色のパルスアニメーションで「⚠️ システム異常検出」
- 開閉式パネルで詳細を確認可能
- 各異常から直接該当画面へ遷移可能
#### 技術的なハイライト
複雑な SQL クエリの使用:
    # スパム疑いユーザーの検出
    spam_users = User.joins(:posts)
      .where("posts.created_at >= ?", 24.hours.ago)
      .group("users.id")
      .having("COUNT(posts.id) >= 20")
      .select("users.*, COUNT(posts.id) as post_count")
Stimulus.js によるインタラクティブな UI:
    // app/javascript/controllers/anomaly_controller.js
    export default class extends Controller {
      static targets = ["content"]
      toggle() {
        this.contentTarget.classList.toggle("hidden")
      }
    }
---
### 5. デザインの統一化 🎨
**実装時間**: 約 20 分
#### 課題
お知らせ管理画面だけがカード型レイアウトで、他の管理画面（テーブル型）と統一感がなかった。
#### 対応
- カード型 → テーブル型に変更
- 検索フォームの配置を他画面と統一
- すべての機能（公開/非公開切り替え、編集、削除）を維持しながらデザインを刷新
#### 結果
- すべての管理画面で一貫性のある UI を実現
- 操作性の向上
---
### 6. テストデータ生成スクリプトの作成 🧪
**実装時間**: 約 30 分
#### 目的
異常検知機能のテストを簡単に実施できるようにする。
#### 実装内容
- テスト用ダミーデータの作成スクリプト（`db/scripts/create_anomaly_test_data.rb`）
- データ削除スクリプト（`db/scripts/delete_anomaly_test_data.rb`）
- 5 種類の異常パターンを再現するデータ生成
#### 実行方法
    rails runner db/scripts/create_anomaly_test_data.rb  # 作成
    rails runner db/scripts/delete_anomaly_test_data.rb  # 削除
## 🔍 最終品質チェック
### セキュリティ監査
- ✅ SQL インジェクション対策（すべてプレースホルダー使用）
- ✅ 権限チェック（`Admin::BaseController` で一元管理）
- ✅ CSRF 対策（Rails デフォルト）
- ✅ XSS 対策（Rails デフォルトエスケープ）
### パフォーマンス監査
- ✅ N+1 クエリ対策（`includes` 使用）
- ✅ ページネーション（Kaminari、20 件/ページ）
- ✅ 適切なインデックス設定
### コード品質
- ✅ DRY 原則の遵守
- ✅ 責務の分離（Controller / Model / View）
- ✅ エラーハンドリングの実装
**結果**: バグゼロ、すべての機能が正常動作
---
## 📊 実装統計
| 項目                 | 詳細                      |
| -------------------- | ------------------------- |
| **作業時間**         | 約 4 時間                 |
| **新規作成ファイル** | 10 ファイル               |
| **変更ファイル**     | 15 ファイル               |
| **追加コード行数**   | 約 800 行                 |
| **削除コード行数**   | 約 50 行                  |
| **テスト実行時間**   | 14 秒（156 テストケース） |
---
## 💡 学びと振り返り
### 良かった点
1. **異常検知の実装**: 運用を見据えた「攻め」の機能を実装できた
2. **段階的な実装**: 小さく作って動作確認を繰り返す手法が効率的だった
3. **ドキュメント化**: 技術資料を作成することで、知見の定着と共有が可能に
### 改善点
1. **設計段階での検討**: 散歩記録管理が当初抜けていた → 要件定義の重要性を再認識
2. **デザイン統一**: 初期段階でデザインガイドラインを決めておくべきだった
### 次回への活かし方
- 機能追加時は全体を俯瞰し、整合性を確認
- UI/UX のガイドライン策定を早期に実施
---
## 🚀 次のステップ
### 実装予定（優先度順）
1. アクティビティログ（監査ログ）の実装
2. 統計レポート機能（グラフ表示）
3. バッチ操作機能
### 運用面
- プロダクション環境でのログ監視
- 異常検知の閾値チューニング

---
## 📸 スクリーンショット
### 管理者ダッシュボード
<img width="1783" height="1227" alt="image" src="https://github.com/user-attachments/assets/78695b75-f396-45dc-9e7c-437e5389bfe9" />

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-12-15*  
*Created: 2025-12-15 23:46:37*
