# TIL - 2026年01月07日

## 今日のメモ
勉強時間：10時間

午前中に開発アプリのバグ修正をして午後に読書をしつつ、Rails応用を進めた。みんなの作ったアプリを触るの楽しすぎる :laughing: 
React使ったミニアプリを作りたいなぁ…

# 📝 技術学習記録 - 2026年1月8日
## 🎯 本日の目標

Ruby on Rails応用カリキュラムにおける記事管理機能の改修と、バグ修正を行う。

---
## 📌 作業内容① - 記事プレビューのバグ修正
### 🐛 発生していた問題
記事プレビュー画面で `TypeError` が発生し、プレビューが表示できない不具合が発生。
### 🔍 原因調査
`Article#build_body` メソッド内で、`ArticleBlock` に紐づく `Sentence` の [body](cci:1://file:///home/nukon/ws/93715_Yadon987_runteq_curriculum_advanced/app/models/article.rb:66:2-83:5) が `nil` の場合に、文字列結合（`<<`演算子）で `nil` を連結しようとしてエラーが発生していることを特定。
### ✅ 解決策
`sentence.body` を `sentence.body.to_s` に変更し、`nil` を空文字列に変換することでエラーを回避。
### 💡 学んだこと
- Rubyの `to_s` メソッドは `nil` に対しても安全に呼び出せ、空文字列を返す
- デバッグ時は `binding.b` を活用してステップ実行で原因を特定する重要性
### 📷 スクリーンショット
---
## 📌 作業内容② - 記事ステータスに「公開待ち」を追加
### 📋 要件
1. ステータスに「公開待ち(publish_wait)」を追加
2. 公開日時が未来の場合は自動的に「公開待ち」に設定
3. 公開日時が過去になったら自動的に「公開」に変更（Rakeタスク + Whenever）
4. 公開日時の選択を1時間単位に変更
### 🛠️ 実装内容
#### 1. Articleモデルの修正
- `enum state` に `publish_wait: 2` を追加
- 日本語ロケールファイルに「公開待ち」の翻訳を追加
#### 2. コントローラーのロジック修正
**更新ボタン押下時の挙動:**
| 条件 | 結果 |
|------|------|
| ステータス「公開」or「公開待ち」＋ 未来の公開日時 | → 公開待ちに変更 |
| ステータス「公開」or「公開待ち」＋ 過去の公開日時 | → 公開に変更 |
| ステータス「下書き」 | → 下書きのまま |
**公開ボタン押下時の挙動:**
| 条件 | 結果 | フラッシュメッセージ |
|------|------|---------------------|
| 公開日時が未来 | 公開待ちに変更 | 「公開待ちにしました」 |
| 公開日時が過去 | 公開に変更 | 「公開しました」 |
#### 3. 自動公開機能の実装
- **Rakeタスク**: `article_state:update_article_state`
  - 公開待ち状態かつ公開日時を過ぎた記事を自動で「公開」に変更
  - `find_each` を使用したメモリ効率の良いバッチ処理
- **Whenever設定**: 1時間ごとにRakeタスクを自動実行
#### 4. DateTimePickerの修正
- フォーマットを `YYYY-MM-DD HH:mm` から `YYYY-MM-DD HH:00` に変更
- 1時間単位での公開日時指定が可能に
### 💡 学んだこと
- **Rakeタスク**: カスタムタスクの作成と実行方法
- **Whenever**: cronジョブをRuby DSLで管理する方法
- **find_each**: 大量データを効率的に処理するActiveRecordメソッド
- **Fat Controllerの解消**: ビジネスロジックの適切な配置
### 📷 スクリーンショット
---
## 🧪 テスト結果
全テスト合格を確認:
- 12 examples, 0 failures, 1 pending
- RuboCop: no offenses detected
---
## 📂 変更ファイル一覧
| ファイル | 変更内容 |
|----------|----------|
| app/models/article.rb | enumにpublish_waitを追加、build_bodyメソッドのバグ修正 |
| app/controllers/admin/articles_controller.rb | updateアクションにステータス判定ロジックを追加 |
| app/controllers/admin/articles/publishes_controller.rb | 公開ボタンのロジックを修正 |
| app/assets/javascripts/admin.js | DateTimePickerのフォーマットを変更 |
| config/locales/enums.ja.yml | 公開待ちの日本語翻訳を追加 |
| lib/tasks/article_state.rake | 自動公開用Rakeタスクを新規作成 |
| config/schedule.rb | Wheneverの定期実行設定を追加 |
---
## 🚀 本日のコミット
1. `fix: 記事プレビューでSentence.bodyがnilの場合のTypeErrorを修正`
2. `feat: 記事ステータスに公開待ち(publish_wait)を追加`
---
## 📝 振り返り
本日は記事管理機能の改修を中心に作業を行いました。特に「公開待ち」ステータスの実装では、単純なenum追加だけでなく、コントローラー内でのステータス判定ロジック、Rakeタスクによるバッチ処理、Wheneverによる定期実行設定など、実務で必要となる複数の技術要素を組み合わせて実装することができました。
また、バグ修正では原因の特定からテストによる検証まで、一連のデバッグプロセスを経験し、`nil` 安全なコーディングの重要性を再認識しました。

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-01-07*  
*Created: 2026-01-09 00:07:26*
