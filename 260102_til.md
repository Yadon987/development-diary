# TIL - 2026年01月02日

## 今日のメモ
勉強時間：12時間

ゲストモード地味に大変だな…

# 📅 開発日誌：ポートフォリオ閲覧機能（ゲストモード）の実装と堅牢性向上
**Date:** 2026-01-02
**Tech Stack:** Ruby on Rails 7, PostgreSQL, Docker, AWS (S3), Supabase, Google Fit API

---

## 🚀 今日のハイライト

ポートフォリオとして採用担当者や外部ユーザーの方にアプリをスムーズに体験していただくための**「ゲストモード（ポートフォリオ閲覧機能）」**を実装しました。
また、開発環境と本番環境の接続設定を厳格に分離し、開発の安全性と効率性を向上させるDevOps的な改善も行いました。

---

## ✨ 主要な実装機能

### 1. ゲストログイン機能（ポートフォリオ閲覧モード）

Googleアカウント連携が必須のヘルスケアアプリにおいて、外部ユーザーが個人情報を入力せずにアプリの全容を体験できる仕組みを構築しました。
*   **課題**: Google Fit連携がないとデータが表示されず、アプリの魅力が伝わらない。
*   **解決策**:
    *   **ワンクリック・ログイン**: 登録不要で即座にログインできるゲスト機能を作成。
    *   **データシミュレーション**: 管理者の散歩記録、投稿、実績データをゲストユーザーに複製するロジックを実装し、**「入った瞬間からリッチなデータが見られる」**状態を実現。
    *   **Google Fit APIの仮想化**: ゲスト時は外部APIを叩かず、ダミーデータを生成するServiceクラスへの切り替えを行い、API制限や認証の壁を回避。

### 2. 機能制限とセキュリティ制御 (RBAC)

ゲストユーザーは「閲覧専用」と定義し、データの整合性を守るための制限を実装しました。
*   **実装内容**:
    *   **Controllerレベルのガード**: `before_action` やガード節で、投稿・リアクション・設定変更（アバター含む）をブロック。
    *   **Viewの条件分岐**: 編集ボタンや連携ボタンを非表示にし、誤操作を未然に防ぐUI設計。
    *   **ランキングの可視性制御**: ゲストユーザーは一般ランキングには表示されないが、ゲスト自身の画面ではランキングに参加しているように見える（自分と他のユーザーが見える）特殊なスコープを定義。
<!-- 📷 ここに「投稿ボタンがロックされている画面」や「ランキング画面」のスクリーンショットを貼ってください -->
(Screen Shot: Locked Features or Ranking View)
---
## 🛠 インフラ・開発環境の改善
### 3. 環境変数の厳格な分離と事故防止
開発効率を上げる中で発生した「開発環境から本番DBへの接続リスク」に対し、根本的な再発防止策を講じました。
*   **対応**:
    *   `.env` (開発用) と `.env.production` (本番用) を明確にファイルを分離。
    *   `DATABASE_URL` などのクリティカルな変数が開発環境に混入しないよう管理フローを見直し。
    *   [README.md](cci:7://file:///home/nukon/ws/tekumemo/README.md:0:0-0:0) に環境変数管理のセクションを追記し、チーム（および未来の自分）へのドキュメント化を徹底。
### 4. WSL2開発環境のセットアップ効率化
開発マシンの再構築も見据え、環境構築を自動化するシェルスクリプト `bin/setup_wsl_env.sh` を整備。
Docker環境のヘルスチェック機能を含むテスト実行スクリプト [bin/test_all.sh]の改善により、CI/CDを見据えた品質保証体制を強化しました。
---
## 🧪 品質保証 (Testing)
*   **System Specの拡充**: ゲストモードの挙動（ログイン、データ表示、機能制限）を網羅するE2Eテストを追加。
*   **カバレッジ**: 全320件のテストケースをオールグリーン化 ✅
*   **バグ修正**: 
    *   データコピー時のバリデーションエラー修正。
    *   ActiveRecordのスコープにおける引数ハンドリングの修正。
<!-- 📷 ここに「テストオールグリーンのターミナル画面」のスクリーンショットを貼ってください -->
(Screen Shot: RSpec All Green Result)
---
## 📝 まとめ & 学び
今日は「ユーザー（閲覧者）に価値をどう届けるか」というUXの観点と、「開発者としてどう安全を担保するか」というDXの観点の両方で大きな進捗がありました。
特にゲストモードの実装では、Service層での依存関係の分離が功を奏し、本番コードを汚さずにダミーデータへの切り替えが実現できました。この設計は今後の拡張にも活きると確信しています。

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-01-02*  
*Created: 2026-01-03 05:20:40*
