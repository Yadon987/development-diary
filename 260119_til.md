# TIL - 2026年01月19日

## 今日のメモ
勉強時間：12時間

画面遷移図のブラッシュアップ完了！卒制LGTMいただきました！
massanに非常に参考になるアドバイスもいただけてラッキー
次はのりぴーさんと清水講師のアドバイスを参考にER図のブラッシュアップに取り組みます :ultra_fast_parrot: 

# 📝 開発日誌（2026年1月19日）

## 📸 スクリーンショット
[![Image from Gyazo](https://i.gyazo.com/22f9fa3b37be5ff4c8dd833611954209.png)](https://gyazo.com/22f9fa3b37be5ff4c8dd833611954209)

## 👤 基本情報
- **プロジェクト名**: てくメモ（tekumemo）
- **技術スタック**: Ruby on Rails 7 / PostgreSQL / TailwindCSS / Hotwire
- **作業ブランチ**: 28-refactor-users-table

---

## 🎯 本日の目標

usersテーブルのリファクタリング計画を策定し、PRを作成して技術メンターへの相談準備を完了させる。

---

## 📋 作業内容

### 1. 🏗️ Usersテーブル正規化リファクタリング計画の策定

肥大化していた `users` テーブル（27カラム）を分析し、責務分離による正規化計画を策定しました。

#### 🔍 現状分析
現行の `users` テーブルには以下のような課題がありました：
- **Fat Model問題**: 認証・設定・プロフィール・外部連携など異なる責務が1テーブルに混在
- **メモリ効率**: 認証時に不要なトークンや設定値までロードされる
- **保守性**: 機能追加のたびにテーブルが肥大化

#### 📐 設計した正規化構成

| テーブル名 | 責務 | 主要カラム |
|:--|:--|:--|
| `users` | 認証・権限管理 | email, encrypted_password, role, Trackable系 |
| `google_accounts` | 外部連携 | google_uid, google_token, google_refresh_token |
| `user_settings` | ユーザー設定 | goal_meters, walk_reminder系, is_reaction_summary |
| `user_profiles` | 表示情報 | name, avatar_url, avatar_type |

#### 🗑️ レガシーカラムの調査

Git履歴とコード全体を調査し、`is_admin` カラムが使用されていないことを確認しました。

- 2025/12/11: `is_admin` (boolean) を追加
- 2025/12/14: `role` (integer enum) を追加 → 以降 `role` のみ使用

結論として `is_admin` は削除可能なレガシーカラムと判断しました。

---

### 2. 📄 技術ドキュメントの作成

#### 作成したドキュメント
- **docs/refactoring_plan_users_table.md**: 正規化計画の技術仕様書（114行）
- **pr_body.md**: PR用の概要説明文（158行）

#### ドキュメントに含めた内容
- 現状のカラム構成と移動先の対応表
- 各テーブルのマイグレーション設計（create_table構文付き）
- 実装フェーズと工数見積もり
- N+1問題への対策方針
- 期待される効果の明文化

---

### 3. 🌿 ブランチ作成とPR準備

不要なマイグレーションファイル（NO FILE問題）を解決した上で、新しい作業ブランチを作成しました。

- **ブランチ名**: `28-refactor-users-table`
- **コミット**: `docs: Usersテーブル正規化リファクタリング計画書の追加`
- **リモートへのプッシュ完了**

---

## 💡 技術的な学び・ポイント

### 正規化設計時の考慮事項
- 1対1リレーションでも、オプショナルなデータ（Google連携未使用ユーザー）は別テーブルに分離することでストレージを節約できる
- N+1問題を意識し、頻繁にアクセスされるカラム（name, avatar_url）の配置を慎重に検討

### Git運用
- 計画段階でPRを作成し、実装前にメンターへ相談するワークフローを採用
- ドキュメントファーストでレビューを受けやすい形に整備

---

## 📊 成果物

| 成果物 | 概要 |
|:--|:--|
| docs/refactoring_plan_users_table.md | 正規化計画の技術仕様書 |
| pr_body.md | PR用の概要説明（絵文字装飾付き） |

---

## 🚀 次のステップ

1. 技術メンターへの相談・レビュー依頼
2. フィードバックを反映して計画を調整
3. Phase 1（google_accounts テーブル分離）から実装開始

---

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-01-19*  
*Created: 2026-01-19 22:07:24*
