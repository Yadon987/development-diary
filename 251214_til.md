# TIL - 2025年12月14日

## 今日のメモ
勉強時間：9時間

DB復旧成功！死ぬかと思った…Xでも言いましたがそのうちに技術記事にするつもりです :+1: 


# 2025-12-14 開発日誌
## 🎯 本日の目標
- 通知機能（Web Push）の実装と安定化
- テスト環境の改善（高速化・安定化）
- CI/CDパイプラインの整備
## ✅ 実施内容
### 1. 通知機能の実装
- **Web Push通知:** Service WorkerとVAPIDキーを使用したプッシュ通知基盤を構築。
- **リマインダー機能:**
  - `InactiveReminderService`: 3日間ログインがないユーザーへの通知。
  - `WalkReminderService`: 散歩記録がないユーザーへの通知。
  - `ReactionSummaryService`: リアクション集計通知。
- **設定UI:** ユーザーごとの通知設定画面を作成。
### 2. テスト環境の劇的な改善
- **Cupriteへの移行:** Selenium (ChromeDriver) から Cuprite (CDP) へ移行し、E2Eテストを高速化。
- **並列実行の導入:** `parallel_tests` を導入し、4プロセスでの並列実行を実現。
- **Flaky Testの撲滅:**
  - 非同期処理（天気予報表示など）の待機処理を強化。
  - ログアウト処理やモーダル操作のセレクタを堅牢化。
  - 外部フォント読み込みをブロックし、タイムアウトを防止。
### 3. 開発環境・DB周りの整備
- **PostgreSQL接続問題の解決:** ローカル(5433)とDocker(5432)のポート競合を解消し、Dockerベースの開発環境に統一。
- **CI互換性:** [database.yml](cci:7://file:///home/nukon999/workspace/tekumemo/config/database.yml:0:0-0:0) を環境変数優先に修正し、GitHub Actionsとローカルの両方で動作するように調整。
## 🛠 技術的課題と解決
### 💥 PostgreSQLのポート競合と認証エラー
- **課題:** ローカルで意図せずPostgreSQLがポート5433で起動しており、Railsが接続できずにテストが落ちていた。また、`postgres` ユーザーのパスワード認証で躓いた。
- **解決:** ローカルのPostgreSQLを停止し、Docker Composeでポート5432のDBを起動。[database.yml](cci:7://file:///home/nukon999/workspace/tekumemo/config/database.yml:0:0-0:0) を `host: 127.0.0.1` に設定してTCP接続を強制することで解決。
### 🐢 System Specのタイムアウト
- **課題:** 外部フォント（Google Fonts）へのアクセスが遅く、Cupriteがタイムアウトしていた。
- **解決:** [rails_helper.rb](cci:7://file:///home/nukon999/workspace/tekumemo/spec/rails_helper.rb:0:0-0:0) の `url_blacklist` にフォントのURLを正規表現で指定し、リクエストをブロックすることで高速化。
## 📝 学び
- **Cupriteの `url_blacklist`:** テストに関係ない外部リソースをブロックするのは、E2Eテスト高速化の定石。
- **Docker vs ローカルDB:** 開発環境はDockerに寄せたほうが、ポートやバージョンの管理が楽になる。
- **`git commit --amend`:** 細かい修正を繰り返すより、一つの意味あるコミットにまとめるほうが履歴が綺麗になる。
## 🚀 次回の予定
- GitHub ActionsでのCI実行結果の確認と、もし落ちていれば修正。
- 通知機能の実機検証（PWA）。

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-12-14*  
*Created: 2025-12-15 00:02:46*
