# TIL - 2025年12月12日

## 今日のメモ
勉強時間：11時間

ポンポンペイン直ったので絶好調！リマインドに苦戦中でAI使いすぎた

# 開発日誌 - Web Push通知機能の実装

**日付**: 2025年12月12日  
**作業ブランチ**: `12-notification-feature` → `claude/review-notification-feature-018mqc1DeZEfqoiM6kd8Ep5Y`  
**作業時間**: 約6時間

---

## 📋 実装した機能

### 1. Web Push通知の基盤実装
- **技術スタック**: Web Push API, Service Worker, VAPID認証
- **実装内容**:
  - Service Workerによるバックグラウンド通知
  - Stimulus.jsを使った購読管理UI
  - VAPIDキーによる安全な通知配信
  - 購読の自動管理（無効化検知と削除）

### 2. 散歩時間リマインド通知
- ユーザーが設定した時刻に散歩を促す通知を送信
- 今日の散歩記録がない場合のみ通知
- 10分の許容範囲を設けて柔軟な配信を実現

### 3. 非アクティブユーザーリマインド通知
- 最終散歩日からの経過日数を計算
- ユーザー設定の閾値（デフォルト3日）に達した場合のみ通知
- 毎日送らない設計で適切なタイミングでの再エンゲージメント

### 4. リアクションまとめ通知
- 前日に受け取ったリアクションを集計
- 上位3種類のリアクションを絵文字付きで表示
- ユーザーの設定に応じて通知ON/OFF可能

---

## 🐛 技術的課題と解決

### Issue 1: タイムゾーン問題による通知の不達
**問題**:
```ruby
# 問題のあったコード
User.where(walk_reminder_enabled: true)
    .where("EXTRACT(HOUR FROM walk_reminder_time) = ?", Time.current.hour)

データベース側でEXTRACT(HOUR...)を実行するとUTC時刻で評価
ユーザーの設定時刻（JST 17:08）が8時間ずれて比較され、マッチせず
解決策:

# 修正後のコード
users.find_each do |user|
  reminder_hour = user.walk_reminder_time.hour  # Ruby側でJST時刻を取得
  current_hour = Time.current.hour
  
  if current_hour == reminder_hour && (current_min - reminder_min).abs <= 10
    # 通知送信
  end
end

データベースクエリからタイムゾーン処理を除去
Ruby側でタイムゾーンを正しく扱うことで解決
結果: テストで正常に通知送信を確認
Issue 2: データベーススキーマの不一致
問題:

ERROR: column walks.date does not exist

サービス層でwalks.dateカラムを参照
実際のスキーマではwalks.walked_onが正しいカラム名
解決策:

WalkReminderService, InactiveReminderServiceの両方を修正
date → walked_onに統一
学び: スキーマ確認の重要性を再認識
Issue 3: 通知が届かない原因の特定困難
問題:

Web Push購読がないユーザーへの通知が静かに失敗
ログ出力がなく、デバッグが困難
解決策:

def self.send_notification(user, title:, body:, url: "/", icon: "/icon-192.png")
  subscriptions = user.web_push_subscriptions
  
  if subscriptions.empty?
    Rails.logger.info "No push subscriptions found for user #{user.id}"
    return
  end
  # ...
end

購読なしの場合に明示的なログを追加
オブザーバビリティの向上
🔧 コード品質の向上
リファクタリング実施内容
デバッグログの整理

開発時の詳細ログを削除
本番運用に必要なログのみ保持
コメントの修正

重複コメントの削除
コードの意図を明確にするドキュメント整備
エラーハンドリングの強化

WebPush::InvalidSubscriptionの適切な処理
無効な購読の自動削除機能
コードレビューで確認した項目
✅ データベース外部キー制約の確認
✅ デフォルト値とNOT NULL制約の検証
✅ N+1クエリの回避（includes, preloadの適切な使用）
✅ エラーハンドリングの網羅性
✅ ログ出力の適切性
📊 テスト結果
動作確認済み項目
# 散歩時間リマインド
WalkReminderService.send_reminders
# => "Sent walk reminder to user 1" ✅

# リアクションまとめ通知
ReactionSummaryService.send_summaries
# => 8人のユーザーに通知送信成功 ✅

# Web Push購読
User.find(1).web_push_subscriptions.count
# => 1件の購読を確認 ✅

🚀 デプロイ準備
実装したRakeタスク
# 散歩時間リマインド（毎時実行推奨）
rake reminder:walk

# 非アクティブリマインド（1日1回）
rake reminder:inactive

# リアクションまとめ（1日1回、朝9時推奨）
rake reminder:reaction_summary

本番環境での推奨設定
Cron/Scheduled Jobsでの定期実行
VAPIDキーの環境変数管理
エラー監視とアラート設定
📈 成果と学び
技術的成果
PWA対応のモダンな通知システムを構築
タイムゾーン処理の深い理解
Service Workerとバックグラウンド処理の実装経験
問題解決のアプローチ
仮説検証型デバッグ: SQLログとRailsコンソールでの段階的検証
根本原因の追求: 表面的な症状ではなく、タイムゾーン処理の構造的問題を特定
観測可能性の重視: ログ出力を充実させ、運用時のデバッグを容易に
コミット履歴の整理
不要なテストコミット（75f77d6）をgit rebaseで削除
クリーンな履歴を維持することでチーム開発への配慮
📝 次のステップ
 本番環境でのcron設定
 通知配信状況のダッシュボード実装
 A/Bテストによる通知タイミングの最適化
 プッシュ通知のクリック率計測

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2025-12-12*  
*Created: 2025-12-12 23:15:49*
