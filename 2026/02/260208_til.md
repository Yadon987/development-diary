# TIL - 2026年02月08日

## 今日のメモ
  # 開発日誌 - 2026年2月8日                                                                                                                                     
                                                                                                               
  ## 🔰 プロジェクト概要                                                                                                                                        
                                                                                                                                                                
  **プロジェクト名**: Aruaru Arena（あるあるアリーナ）
                                                                                                                                                                
  **概要**: Ruby on Rails 8 API + DynamoDB で構築される「あるある」投稿審査アプリケーション。ユーザーの「あるある」投稿を3人のAI審査員（ひろゆき風/デヴィ婦人風/
  中尾彬風）が採点・ランキング化する対戦型Webアプリ。                                                                                                           

  ---

  ## 📸 本日の成果物（スクリーンショット）
![](https://res.cloudinary.com/dd4pdy5p7/image/upload/v1770552665/xl1jnugbmqhclhpedclc.png)

  ---
                                                                                                                                                  
  **技術スタック**:                                                                                                                                             
  - Backend: Ruby 3.2+, Rails 8.0+ (API Mode)
  - Database: DynamoDB (NoSQL)
  - Serverless: AWS Lambda (Dockerコンテナ)
  - Testing: RSpec 8.0+, FactoryBot
  - Infrastructure: Terraform
  - CI/CD: GitHub Actions

  ---

  ## ✅ 本日の主な作業内容

  ### 1. 🚀 Rails 8.0 API + DynamoDB 開発環境のセットアップ

  **成果**:
  - Rails 8.0.44（API Mode）プロジェクトの新規作成
  - ActiveRecord依存を排除し、DynamoDB（Dynamoid gem）のみを使用する構成を構築
  - RSpecテスト環境の構築（spec_helper.rb, rails_helper.rb, factory_bot.rb設定）
  - RuboCop設定（rubocop-rails-omakase採用）
  - Brakeman（セキュリティスキャン）の導入

  **ファイル作成数**: 56ファイル（1,250行追加）

  **主要設定ファイル**:
  - `backend/Gemfile`: ActiveRecordを排除し、DynamoDB関連gemのみを追加
  - `backend/config/initializers/dynamoid.rb`: DynamoDB接続設定
  - `backend/config/initializers/cors.rb`: CORS設定（フロントエンド連携用）
  - `backend/Dockerfile`: Lambda対応のマルチステージビルド

  ### 2. 🔒 インフラ構成の安全性強化（Terraform）

  **実施したセキュリティ対策**:

  | 項目 | 問題 | 対策 | ファイル |
  |------|------|------|----------|
  | シークレット管理 | SECRET_KEY_BASEがハードコード | 変数化（sensitive=true） | `lambda.tf`, `variables.tf` |
  | IAM権限 | DynamoDBへの全テーブルアクセス権限 | 特定テーブルARNのみ許可 | `iam.tf` |
  | 無限ループ対策 | Lambda同時実行数無制限 | `reserved_concurrent_executions = 5` | `lambda.tf` |
  | DDoS対策 | API Gatewayスロットリング未設定 | `throttling_rate_limit = 10` | `api_gateway.tf` |
  | コスト管理 | ログ/イメージ蓄積リスク | CloudWatch 7日保持、ECR 5世代保持 | `cloudwatch.tf`, `ecr_lifecycle.tf` |

  **Terraform構成**:
  - Lambda（Dockerコンテナ）
  - DynamoDB（4テーブル：posts, judgments, rate_limits, duplicate_checks）
  - API Gateway（HTTP API）
  - ECR（コンテナレジストリ）
  - CloudWatch Logs（7日保持）

  **コスト見積もり**:
  - 通常運用: $0/月（無料枠内）
  - 無料枠終了後: $0.10〜$0.50/月
  - 最悪ケース: $5/月以下

  ### 3. 📊 DynamoDB PITR（Point-In-Time Recovery）有効化

  **実施内容**:
  - DynamoDBテーブルにPITRを有効化
  - データ保護強化（過去35日間の任意時点への復元可能）
  - `PointInTimeRecoverySpecification`設定を追加

  **変更ファイル**:
  - `backend/terraform/dynamodb.tf`

  ### 4. 🐳 Docker Compose 最適化（2025年ベストプラクティス対応）

  **実施内容**:
  - `version: '3.8'` の削除（Docker Compose V2では不要）
  - `healthcheck.start_period` の追加（コンテナ起動猶予時間）
  - テスト用DB（dynamodb-test）の追加（インメモリ高速起動）
  - DynamoDB Admin GUI（dynamodb-admin）の追加

  **サービス構成**:
  - 開発用DynamoDB（ポート8000、永続化あり）
  - テスト用DynamoDB（ポート8002、インメモリ）
  - DynamoDB Admin GUI（ポート8001、Web管理画面）

  ### 5. 📚 ドキュメント整備

  **作成・更新したドキュメント**:

  1. **開発手順書**（1,746行）
     - プロジェクト概要、技術スタック
     - Windows 11 + WSL2開発環境セットアップ手順
     - CodeRabbit導入手順
     - Skills使用方法
     - テスト環境構築（E01）の進捗
     - インフラ構築（E02）の進捗
     - 開発ワークフロー（TDDサイクル）
     - 実装順序の推奨（フェーズ0〜5）

  2. **プロジェクト構成定義**（`docs/directory_structure.md`）
     - バックエンドディレクトリ構造
     - フロントエンドディレクトリ構造
     - インフラディレクトリ構造

  3. **SDD/TDDテンプレート**（`.github/ISSUE_TEMPLATE/spec.md`）
     - 仕様駆動開発テンプレート
     - テスト駆動開発チェックリスト

  4. **CLAUDE.md**（プロジェクトルール）
     - 絶対禁止事項（`.permit!`、N+1クエリ等）
     - 必須コーディングルール
     - 変更後の検証手順
     - コミュニケーションスタイル

  5. **README.md**の更新
     - プロジェクト概要
     - 技術スタック
     - セットアップ手順
     - 開発ワークフロー

  6. **Epic一覧**（`docs/epics.md`）の作成
     - 17個のEpic（E01-E17）を定義
     - 優先順位（P0-P3）と依存関係を整理
     - 実装順序（フェーズ0〜5）を設計

  ### 6. 🤖 CodeRabbit & AIツール導入

  **実施内容**:
  - CodeRabbit設定ファイル（`.coderabbit.yaml`）の作成
    - 日本語でのレビュー設定
    - プロジェクト固有ルール（CLAUDE.md準拠）
    - N+1クエリ、セキュリティの重点チェック

  - CodeRabbitレビュースキルの作成（`.agent/skills/coderabbit-review/SKILL.md`）

  ### 7. ⚙️ CI/CD設定の最適化

  **実施内容**:
  - GitHub Actionsワークフロー（`.github/workflows/ci.yml`）の作成
    - テスト実行（RSpec）
    - RuboCop lint
    - Brakemanセキュリティスキャン
    - デプロイパイプライン（AWS認証、Dockerビルド、Terraform適用）

  ### 8. ☁️ AWSデプロイ検証（Terraform）

  **実施内容**:
  - Terraformを使用してAWS Lambda + API Gateway構成をデプロイ
  - ECRリポジトリの作成
  - Dockerイメージのビルドとプッシュ
  - Lambda関数、API Gateway、DynamoDBテーブルの作成
  - ヘルスチェックエンドポイントの動作確認

  **検証結果**:
  ```bash
  curl https://zzi7p6lmn5.execute-api.ap-northeast-1.amazonaws.com/health
  # {"status":"Running!","env":"production"}

  主な修正:
  - DockerfileのLambda対応（aws_lambda_ric使用）
  - Lamby gemの導入（Rackアダプター）
  - SECRET_KEY_BASEの安全な管理

  ---
  📈 本日の成果数値

  - コミット数: 10件
  - 追加ファイル: 56ファイル（Rails環境）
  - 変更ファイル: 20ファイル（インフラ強化）
  - 追加コード行数: 約1,670行
  - ドキュメント行数: 約2,500行
  - Terraformリソース: 7種類（Lambda, API Gateway, DynamoDB x4, ECR, CloudWatch）

  ---
  🎯 技術的ハイライト

  1. ActiveRecordを排除したNoSQL特化構成

  Rails 8.0のActiveRecord依存を完全に排除し、DynamoDB（Dynamoid
  gem）のみを使用する構成を実現。これにより、サーバーレス環境でのスケーラビリティとコスト効率を最大化。

  2. セキュリティとコストの両立

  - IAM権限の最小権限化
  - Lambda同時実行数制限（爆発リスク防止）
  - API Gatewayスロットリング（DDoS対策）
  - ECRライフサイクルポリシー（ストレージコスト抑制）
  - CloudWatchログ保持期間制限（ログ蓄積防止）

  → 月額$0〜$5に収める安全策を全て実装済み

  3. 2025年モダン開発基準の適用

  - Docker Compose V2（version削除）
  - GitHub Actions OIDC認証
  - CodeRabbit AIレビュー
  - SDD（仕様駆動開発）+ TDD（テスト駆動開発）

  ---
  📝 次回の作業予定

  直近のタスク

  1. **E01: テスト環境構築（バックエンド）**の完了
    - SimpleCovの設定（カバレッジ90%以上）
    - VCR（API Mocking）の設定
    - DynamoDB Localとの連携
  2. E03: DynamoDBスキーマ定義
    - 4テーブルの設計・実装（posts, judgments, rate_limits, duplicate_checks）
  3. E05: 投稿APIの実装
    - Thread方式で非同期審査をトリガー
    - レート制限（5分1回）

  フェーズ順序

  - フェーズ0: 環境セットアップ（E01, E02✅, E03, E04）
  - フェーズ1: 投稿・審査の基本フロー（E05, E06, E07）

  ---
  🔗 参考リンク

  - リポジトリ: aruaruarena
  - 使用したAIツール: Claude Code（Sonnet 4.5）+ CodeRabbit
  - AWSリージョン: ap-northeast-1（東京）
  - API Gatewayエンドポイント: https://zzi7p6lmn5.execute-api.ap-northeast-1.amazonaws.com/

  ---
  💡 今日の学び・気づき

  1. Rails 8.0のモダンな構成: railties個別gemを使用することで、不要なActiveRecord依存を排除できる
  2. Terraformのセキュリティ: sensitive = trueを使用することで、シークレットを安全に管理できる
  3. サーバーレスのコスト管理: 同時実行数制限とスロットリング設定が、高額請求防止に不可欠
  4. ドキュメントの重要性: Epic一覧（E01-E17）を作成することで、長期的な開発ロードマップが明確になった

## 気分・状態
今日の気分: 😁 (5: とても気分が良い)
今日のモチベーション: 🌈 (5: とてもやる気がある)
目標の進捗: 🌳 (5: とてもよく進んだ)

---
*Generated by ちいくさ日記*  
*Date: 2026-02-08*  
*Created: 2026-02-08 22:47:22*
